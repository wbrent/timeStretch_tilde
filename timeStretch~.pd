#N canvas 638 255 663 344 10;
#X declare -path ./lib;
#X obj 37 254 outlet~;
#X obj 37 230 hip~ 5;
#X obj 37 53 inlet;
#N canvas 115 201 965 649 command-parsing 0;
#X obj 49 60 inlet;
#X obj 522 85 list split 1;
#X obj 522 117 t b a;
#X obj 522 217 s;
#X obj 612 174 symbol;
#X obj 522 154 list;
#X obj 522 174 list trim;
#X obj 612 154 makefilename \$0-timestretch-%s;
#N canvas 49 366 712 533 play-command 0;
#X obj 43 47 inlet;
#X obj 43 375 list append \$0;
#X msg 43 416 \; \$6-timestretch-\$1-rewind bang \; \$6-timestretch-\$1-tablename
\$2 \; \$6-timestretch-\$1-speed \$3 \; \$6-timestretch-\$1-gain \$4
\; \$6-timestretch-\$1-transpo \$5 \;;
#N canvas 840 463 635 532 duration-to-speed 0;
#X obj 147 35 inlet;
#X obj 37 425 outlet;
#X obj 37 399 pack f s f f f;
#X obj 147 76 unpack f s f f f f f f;
#X text 212 28 player voice ID \, sample table symbol \, samplerate
\, duration \, gain \, transpo \, onset duration \, release %;
#X obj 280 355 pack f f f f f \$0 f;
#X text 19 457 tablereader voice ID \, sample table symbol \, speed
\, gain \, transpo, f 30;
#N canvas 1541 48 359 374 calc-sustain-release-times 0;
#X obj 55 268 outlet;
#X obj 185 268 outlet;
#X obj 135 121 r \$0-ts-play-release;
#X obj 55 89 max;
#X obj 120 176 *;
#X obj 135 146 / 100;
#X obj 55 141 t f f;
#X obj 55 213 -;
#X obj 70 61 r \$0-ts-play-onset-dur;
#X obj 55 39 r \$0-ts-play-dur;
#X floatatom 180 212 10 0 0 3 release-time - -, f 10;
#X floatatom 103 311 10 0 0 3 sustain-time - -, f 10;
#X connect 2 0 5 0;
#X connect 3 0 6 0;
#X connect 4 0 7 1;
#X connect 4 0 1 0;
#X connect 4 0 10 0;
#X connect 5 0 4 1;
#X connect 6 0 7 0;
#X connect 6 1 4 0;
#X connect 7 0 0 0;
#X connect 7 0 11 0;
#X connect 8 0 3 1;
#X connect 9 0 3 0;
#X restore 335 295 pd calc-sustain-release-times;
#X obj 266 146 s \$0-ts-play-dur;
#X obj 286 126 s \$0-ts-play-onset-dur;
#X obj 306 106 s \$0-ts-play-release;
#X obj 317 275 r \$0-ts-play-onset-dur;
#X obj 246 166 s \$0-ts-play-sr;
#X obj 391 315 r \$0-ts-play-sr;
#N canvas 919 92 686 573 calc-speed 0;
#X obj 202 492 outlet;
#X obj 202 100 /;
#X obj 202 269 t b f;
#X obj 202 331 /;
#X obj 202 353 * 100;
#X obj 202 291 f;
#X obj 202 205 t b f;
#X obj 202 236 f;
#X obj 202 122 * 1000;
#X obj 420 372 t f b;
#X msg 460 402 100;
#X obj 202 413 spigot;
#X obj 420 349 spigot;
#X obj 453 292 swap 1;
#X obj 453 314 -;
#X obj 202 78 array size;
#X obj 257 264 max 0;
#X obj 479 233 == 0;
#X obj 479 208 max 0;
#X obj 466 349 tgl 15 0 empty empty empty 17 7 0 10 -262144 -1 -1 0
1;
#X obj 252 413 tgl 15 0 empty empty empty 17 7 0 10 -262144 -1 -1 0
1;
#X floatatom 19 158 10 0 0 3 sample-dur-ms - -, f 10;
#X floatatom 19 268 10 0 0 3 post-onset-playback-dur - -, f 10;
#X floatatom 19 368 10 0 0 3 play-speed-factor - -, f 10;
#X floatatom 390 458 10 0 0 3 play-speed-percent - -, f 10;
#X floatatom 19 458 10 0 0 0 - - -, f 10;
#X obj 257 240 -;
#X obj 479 188 r \$0-ts-play-onset-dur;
#X obj 272 212 r \$0-ts-play-onset-dur;
#X obj 257 192 r \$0-ts-play-dur;
#X obj 232 100 r \$0-ts-play-sr;
#X obj 202 24 inlet;
#X obj 332 492 outlet;
#X obj 259 52 r \$0-ts-play-sample;
#X text 512 353 If there's an onset duration specified \, send a 100%
play speed value first \, then output the play speed that will occur
post-onset out the right outlet, f 17;
#X floatatom 19 198 10 0 0 3 sample-dur-post-onset-ms - -, f 10;
#X obj 202 143 -;
#X obj 232 143 r \$0-ts-play-onset-dur;
#X connect 1 0 8 0;
#X connect 2 0 5 0;
#X connect 2 1 3 1;
#X connect 3 0 4 0;
#X connect 3 0 23 0;
#X connect 4 0 11 0;
#X connect 4 0 12 0;
#X connect 5 0 3 0;
#X connect 6 0 7 0;
#X connect 6 1 5 1;
#X connect 7 0 2 0;
#X connect 7 0 22 0;
#X connect 8 0 21 0;
#X connect 8 0 36 0;
#X connect 9 0 24 0;
#X connect 9 0 32 0;
#X connect 9 1 10 0;
#X connect 10 0 0 0;
#X connect 11 0 25 0;
#X connect 11 0 0 0;
#X connect 12 0 9 0;
#X connect 13 0 14 0;
#X connect 13 1 14 1;
#X connect 14 0 12 1;
#X connect 14 0 19 0;
#X connect 15 0 1 0;
#X connect 16 0 7 1;
#X connect 17 0 13 0;
#X connect 17 0 11 1;
#X connect 17 0 20 0;
#X connect 18 0 17 0;
#X connect 26 0 16 0;
#X connect 27 0 18 0;
#X connect 28 0 26 1;
#X connect 29 0 26 0;
#X connect 30 0 1 1;
#X connect 31 0 15 0;
#X connect 33 0 15 1;
#X connect 36 0 6 0;
#X connect 36 0 35 0;
#X connect 37 0 36 1;
#X restore 93 249 pd calc-speed;
#X obj 226 186 s \$0-ts-play-sample;
#X obj 63 310 r \$0-ts-play-sample;
#X obj 206 206 s \$0-ts-play-voice;
#X obj 37 202 t f b;
#X obj 37 172 r \$0-ts-play-voice;
#X obj 298 255 r \$0-ts-play-voice;
#X msg 280 379 \; \; \$6-timestretch-\$2-bend 0 \; \$6-timestretch-\$2-samplerate
\$7 \; \$6-timestretch-\$2-onset-dur \$3 \; \$6-timestretch-\$2-speed-post-onset
\$1 \; \$6-timestretch-\$2-sustain-time \$4 \; \$6-timestretch-\$2-release-time
\$5 \;;
#X connect 0 0 3 0;
#X connect 2 0 1 0;
#X connect 3 0 17 0;
#X connect 3 1 15 0;
#X connect 3 2 12 0;
#X connect 3 3 8 0;
#X connect 3 4 2 3;
#X connect 3 5 2 4;
#X connect 3 6 9 0;
#X connect 3 7 10 0;
#X connect 5 0 21 0;
#X connect 7 0 5 3;
#X connect 7 1 5 4;
#X connect 11 0 5 2;
#X connect 13 0 5 6;
#X connect 14 0 2 2;
#X connect 14 1 5 0;
#X connect 16 0 2 1;
#X connect 18 0 2 0;
#X connect 18 1 14 0;
#X connect 19 0 18 0;
#X connect 20 0 5 1;
#X restore 43 282 pd duration-to-speed;
#X text 162 370 tablereader voice ID \, sample table symbol \, speed
\, gain \, transpo \, dollar-zero;
#X text 122 232 No more voiceID counter because we're manually assigning
voice;
#X text 157 163 voiceID \, name of table \, file samplerate \, duration
of note (ms) \, gain (dB) \, transposition (cents) \, onset duration
(ms) \, release time (% of duration);
#X obj 43 68 list split 2;
#X obj 43 109 list append;
#X obj 133 109 r \$0-timestretch-0-samplerate;
#X obj 43 130 list append;
#X text 157 32 Insert global samplerate here so that we leave the option
open to making the "play" message require samplerate from the user
in the future. This would be useful if we wanted to allow for mixed
sample rates. Right now \, that seems like overkill and makes the "play"
command unnecessarily bloated.;
#X text 323 108 << this is really the samplerate for voice 0 \, but
all voices get the same samplerate anyway \, so it's global., f 55
;
#X connect 0 0 7 0;
#X connect 1 0 2 0;
#X connect 3 0 1 0;
#X connect 7 0 8 0;
#X connect 7 1 10 1;
#X connect 8 0 10 0;
#X connect 9 0 8 1;
#X connect 10 0 3 0;
#X restore 49 464 pd play-command;
#N canvas 415 310 618 569 attack-command 0;
#X obj 36 19 inlet;
#X obj 36 417 list append \$0;
#N canvas 47 266 818 399 duration-to-speed 0;
#X obj 147 35 inlet;
#X obj 125 314 outlet;
#X obj 48 142 symbol;
#X obj 22 108 t f b f;
#X obj 286 165 pack f f \$0;
#X text 374 48 voiceID \, name of table \, gain (dB) \, transposition
(cents) \, onset duration (ms);
#X obj 147 76 unpack f s f f f;
#X obj 125 288 pack f s f f;
#X text 264 287 voice ID \, sample table symbol \, gain \, transpo
;
#X msg 286 188 \; \$3-timestretch-\$1-bend 0 \; \$3-timestretch-\$1-onset-dur
\$2 \; \$3-timestretch-\$1-speed-post-onset 0 \;;
#X connect 0 0 6 0;
#X connect 2 0 7 1;
#X connect 3 0 7 0;
#X connect 3 1 2 0;
#X connect 3 2 4 0;
#X connect 4 0 9 0;
#X connect 6 0 3 0;
#X connect 6 1 2 1;
#X connect 6 2 7 2;
#X connect 6 3 7 3;
#X connect 6 4 4 1;
#X connect 7 0 1 0;
#X restore 36 304 pd duration-to-speed;
#X text 145 412 tablereader voice ID \, sample table symbol \, gain
\, transpo \, dollar-zero;
#X msg 36 458 \; \$5-timestretch-\$1-transpo \$4 \; \$5-timestretch-\$1-rewind
bang \; \$5-timestretch-\$1-tablename \$2 \; \$5-timestretch-\$1-speed
100 \; \$5-timestretch-\$1-gain \$3 \;;
#N canvas 337 152 764 441 store-array-names 0;
#X obj 49 95 list split 1;
#X obj 99 135 list split 1;
#X obj 199 65 text define \$0-timestretch-attack-arrays;
#X obj 49 35 inlet;
#X obj 49 208 text set \$0-timestretch-attack-arrays;
#X obj 49 178 symbol;
#X obj 49 116 t b f;
#X obj 363 225 until;
#X obj 363 277 f;
#X obj 393 279 + 1;
#X msg 381 253 0;
#X obj 363 172 f;
#X obj 413 172 r \$0-timestretch-num-voices;
#X obj 363 151 r \$0-ts-lb2;
#X obj 363 193 t f b;
#X obj 363 349 text set \$0-timestretch-attack-arrays;
#X obj 363 298 t b f;
#X msg 363 319 symbol NULL;
#X connect 0 0 6 0;
#X connect 0 1 1 0;
#X connect 1 0 5 1;
#X connect 3 0 0 0;
#X connect 5 0 4 0;
#X connect 6 0 5 0;
#X connect 6 1 4 1;
#X connect 7 0 8 0;
#X connect 8 0 9 0;
#X connect 8 0 16 0;
#X connect 9 0 8 1;
#X connect 10 0 8 1;
#X connect 11 0 14 0;
#X connect 12 0 11 1;
#X connect 13 0 11 0;
#X connect 14 0 7 0;
#X connect 14 1 10 0;
#X connect 16 0 17 0;
#X connect 16 1 15 1;
#X connect 17 0 15 0;
#X restore 102 261 pd store-array-names;
#X msg 151 200 1;
#X obj 151 221 tabwrite \$0-timestretch-attack-active-flags;
#X obj 36 100 t l l l;
#X obj 151 172 t b f;
#X obj 151 151 list split 1;
#X text 152 27 voiceID \, name of table \, gain (dB) \, transposition
(cents) \, onset duration (ms);
#N canvas 611 211 417 318 filter-out-unnecessary-attacks 0;
#X obj 40 69 t l l;
#X obj 40 230 spigot;
#X obj 110 109 list split 1;
#X obj 110 140 tabread \$0-timestretch-attack-active-flags;
#X obj 40 251 outlet;
#X obj 40 39 inlet;
#X obj 110 161 swap 1;
#X obj 110 182 -;
#X obj 90 230 tgl 15 0 empty empty empty 17 7 0 10 -262144 -1 -1 1
1;
#X connect 0 0 1 0;
#X connect 0 1 2 0;
#X connect 1 0 4 0;
#X connect 2 0 3 0;
#X connect 3 0 6 0;
#X connect 5 0 0 0;
#X connect 6 0 7 0;
#X connect 6 1 7 1;
#X connect 7 0 1 1;
#X connect 7 0 8 0;
#X restore 36 62 pd filter-out-unnecessary-attacks;
#X connect 0 0 12 0;
#X connect 1 0 4 0;
#X connect 2 0 1 0;
#X connect 6 0 7 0;
#X connect 8 0 2 0;
#X connect 8 1 5 0;
#X connect 8 2 10 0;
#X connect 9 0 6 0;
#X connect 9 1 7 1;
#X connect 10 0 9 0;
#X connect 12 0 8 0;
#X restore 209 404 pd attack-command;
#N canvas 526 361 605 540 playhead-command 0;
#X obj 36 19 inlet;
#X obj 36 417 list append \$0;
#X msg 36 458 \; \$3-timestretch-\$1-location \$2 \;;
#N canvas 89 171 681 468 location-percent-to-ms 0;
#X obj 147 35 inlet;
#X obj 148 298 /;
#X obj 148 320 * 1000;
#X obj 76 404 outlet;
#X obj 148 276 array size;
#X text 286 27 voiceID \, sample table symbol \, samplerate \, location
(percent);
#X obj 147 76 unpack f s f f;
#X obj 148 342 *;
#X obj 324 248 / 100;
#X obj 76 378 pack f f;
#X obj 76 192 t f b;
#X obj 324 222 clip 0 100;
#X connect 0 0 6 0;
#X connect 1 0 2 0;
#X connect 2 0 7 0;
#X connect 4 0 1 0;
#X connect 6 0 10 0;
#X connect 6 1 4 1;
#X connect 6 2 1 1;
#X connect 6 3 11 0;
#X connect 7 0 9 1;
#X connect 8 0 7 1;
#X connect 9 0 3 0;
#X connect 10 0 9 0;
#X connect 10 1 4 0;
#X connect 11 0 8 0;
#X restore 36 294 pd location-percent-to-ms;
#X text 129 261 voiceID \, sample table symbol \, samplerate \, location
(percent);
#X text 82 324 voice ID \, location (ms);
#X obj 36 40 list split 1;
#X obj 36 191 list append;
#X obj 106 61 text get \$0-timestretch-attack-arrays;
#X obj 36 61 t f f;
#X obj 36 221 list append;
#X obj 116 221 r \$0-timestretch-0-samplerate;
#X obj 36 242 list append;
#X obj 106 82 select NULL;
#X msg 106 133 0;
#X obj 36 162 spigot;
#X obj 176 102 t a b;
#X obj 176 153 symbol;
#X msg 136 133 1;
#X text 306 208 << global samplerate for all voices \, so just take
the samplerate for voice 0, f 27;
#X obj 86 162 tgl 15 0 empty empty empty 17 7 0 10 -262144 -1 -1 0
1;
#X connect 0 0 6 0;
#X connect 1 0 2 0;
#X connect 3 0 1 0;
#X connect 6 0 9 0;
#X connect 6 1 12 1;
#X connect 7 0 10 0;
#X connect 8 0 13 0;
#X connect 9 0 15 0;
#X connect 9 1 8 0;
#X connect 10 0 12 0;
#X connect 11 0 10 1;
#X connect 12 0 3 0;
#X connect 13 0 14 0;
#X connect 13 1 16 0;
#X connect 14 0 15 1;
#X connect 14 0 20 0;
#X connect 15 0 7 0;
#X connect 16 0 17 0;
#X connect 16 1 18 0;
#X connect 17 0 7 1;
#X connect 18 0 15 1;
#X connect 18 0 20 0;
#X restore 289 374 pd playhead-command;
#N canvas 971 143 709 750 release-command 0;
#X obj 36 19 inlet;
#X obj 36 647 list append \$0;
#X text 161 552 voice ID \, release-time (ms);
#X msg 36 688 \; \$3-timestretch-\$1-speed 100 \; \$3-timestretch-\$1-note-off-release-time
\$2 \;;
#N canvas 427 547 538 416 format-release-message 0;
#X obj 48 42 inlet;
#X obj 120 182 /;
#X obj 120 204 * 1000;
#X obj 48 318 outlet;
#X obj 120 160 array size;
#X obj 48 83 unpack f s f f;
#X obj 48 292 pack f f;
#X obj 48 116 t f b;
#X text 120 46 voiceID \, name of table \, file samplerate \, release
time (ms);
#X obj 120 248 min;
#X connect 0 0 5 0;
#X connect 1 0 2 0;
#X connect 2 0 9 0;
#X connect 4 0 1 0;
#X connect 5 0 7 0;
#X connect 5 1 4 1;
#X connect 5 2 1 1;
#X connect 5 3 9 1;
#X connect 6 0 3 0;
#X connect 7 0 6 0;
#X connect 7 1 4 0;
#X connect 9 0 6 1;
#X restore 36 484 pd format-release-message;
#X text 120 432 voiceID \, name of table \, file samplerate \, release
time (ms);
#X obj 139 580 unpack f f;
#X floatatom 221 604 5 0 0 0 - - -, f 5;
#X floatatom 139 602 5 0 0 0 - - -, f 5;
#X text 262 468 This should really check to see how much time is left
based on the current playhead position \, and time stretch so that
it plays to the end of the file in exactly the number of (ms) requested
\, fading out as well.;
#X obj 36 80 list split 1;
#X obj 36 351 list append;
#X obj 99 151 text get \$0-timestretch-attack-arrays;
#X obj 36 381 list append;
#X obj 126 381 r \$0-timestretch-0-samplerate;
#X obj 36 402 list append;
#X text 262 245 This re-sends the current sample array name for re-calculating
something in [pd calc-note-off-release-time] in case the playhead position
was changed between an "attack" and "release" message., f 38;
#X obj 36 101 t f f f;
#X msg 169 330 \; \$3-timestretch-\$2-tablename \$1 \;;
#X obj 169 299 pack s f \$0;
#X obj 99 175 select NULL;
#X msg 99 226 0;
#X obj 36 275 spigot;
#X obj 169 195 t a b;
#X obj 169 246 symbol;
#X msg 129 226 1;
#X text 324 380 << global samplerate for all voices \, so just take
the samplerate for voice 0;
#N canvas 1216 81 459 442 filter-out-unnecessary-releases 0;
#X obj 40 69 t l l;
#X obj 40 280 spigot;
#X obj 130 109 list split 1;
#X obj 130 230 tabread \$0-timestretch-attack-active-flags;
#X obj 130 251 &&;
#X obj 160 160 tabread \$0-timestretch-release-active-flags;
#X obj 160 181 swap 1;
#X obj 160 202 -;
#X obj 130 282 select 1;
#X msg 130 303 1;
#X obj 130 324 tabwrite \$0-timestretch-release-active-flags;
#X obj 130 130 t f f f;
#X obj 40 301 outlet;
#X obj 40 39 inlet;
#X obj 90 280 tgl 15 0 empty empty empty 17 7 0 10 -262144 -1 -1 1
1;
#X connect 0 0 1 0;
#X connect 0 1 2 0;
#X connect 1 0 12 0;
#X connect 2 0 11 0;
#X connect 3 0 4 0;
#X connect 4 0 1 1;
#X connect 4 0 8 0;
#X connect 4 0 14 0;
#X connect 5 0 6 0;
#X connect 6 0 7 0;
#X connect 6 1 7 1;
#X connect 7 0 4 1;
#X connect 8 0 9 0;
#X connect 9 0 10 0;
#X connect 11 0 3 0;
#X connect 11 1 5 0;
#X connect 11 2 10 1;
#X connect 13 0 0 0;
#X restore 36 52 pd filter-out-unnecessary-releases;
#X obj 86 275 tgl 15 0 empty empty empty 17 7 0 10 -262144 -1 -1 1
1;
#X connect 0 0 27 0;
#X connect 1 0 3 0;
#X connect 4 0 1 0;
#X connect 4 0 6 0;
#X connect 6 0 8 0;
#X connect 6 1 7 0;
#X connect 10 0 17 0;
#X connect 10 1 15 1;
#X connect 11 0 13 0;
#X connect 12 0 20 0;
#X connect 13 0 15 0;
#X connect 14 0 13 1;
#X connect 15 0 4 0;
#X connect 17 0 22 0;
#X connect 17 1 12 0;
#X connect 17 2 19 1;
#X connect 19 0 18 0;
#X connect 20 0 21 0;
#X connect 20 1 23 0;
#X connect 21 0 22 1;
#X connect 21 0 28 0;
#X connect 22 0 11 0;
#X connect 23 0 24 0;
#X connect 23 1 25 0;
#X connect 24 0 11 1;
#X connect 24 0 19 0;
#X connect 25 0 22 1;
#X connect 25 0 28 0;
#X connect 27 0 10 0;
#X restore 369 344 pd release-command;
#X obj 636 340 until;
#X obj 636 392 f;
#X obj 666 394 + 1;
#X msg 654 368 0;
#X obj 636 296 t b f b;
#X obj 636 434 pack f f \$0;
#X msg 636 456 \; \$3-timestretch-\$1-samplerate \$2 \;;
#X obj 636 274 r \$0-timestretch-samplerate;
#X text 609 21 These are global params;
#N canvas 435 120 556 421 bend-command 0;
#X obj 111 36 inlet;
#X obj 111 140 list append \$0;
#X msg 111 162 \; \$3-timestretch-\$1-bend \$2 \;;
#X obj 175 87 tabread \$0-timestretch-attack-active-flags;
#X obj 111 57 t l l;
#X obj 111 108 spigot;
#X connect 0 0 4 0;
#X connect 1 0 2 0;
#X connect 4 0 5 0;
#X connect 5 0 1 0;
#X restore 449 314 pd bend-command;
#N canvas 927 495 556 421 amp-command 0;
#X obj 111 36 inlet;
#X obj 111 70 list append \$0;
#X msg 111 92 \; \$3-timestretch-\$1-gain \$2 \;;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X restore 529 284 pd amp-command;
#X obj 636 317 f;
#X obj 686 317 r \$0-timestretch-num-voices;
#X msg 522 51 num-voices 16 \, window-size 2048 \, samplerate 44100
;
#X obj 522 21 r \$0-ts-lb1;
#N canvas 435 120 556 421 stop-command 0;
#X obj 111 36 inlet;
#X obj 111 70 list append \$0;
#X msg 111 92 \; \$2-timestretch-\$1-stop-playback bang \;;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X restore 129 434 pd stop-command;
#X obj 288 467 table \$0-timestretch-attack-active-flags;
#X obj 288 487 table \$0-timestretch-release-active-flags;
#X obj 288 507 r \$0-timestretch-num-voices;
#X obj 288 528 pack f \$0;
#X msg 288 549 \; \$2-timestretch-attack-active-flags resize \$1 \;
\$2-timestretch-release-active-flags resize \$1 \;;
#N canvas 435 120 556 421 continue-command 0;
#X obj 111 36 inlet;
#X obj 111 70 list append \$0;
#X msg 111 92 \; \$3-timestretch-\$1-speed \$2 \;;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X restore 422 395 pd continue-command;
#X obj 49 112 route play stop attack playhead continue pause release
bend amp;
#N canvas 435 120 556 421 pause-command 0;
#X obj 111 36 inlet;
#X obj 111 70 list append \$0;
#X msg 111 92 \; \$2-timestretch-\$1-speed 0 \;;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X restore 464 371 pd pause-command;
#X connect 0 0 34 0;
#X connect 1 0 2 0;
#X connect 1 1 5 1;
#X connect 2 0 5 0;
#X connect 2 1 7 0;
#X connect 4 0 3 1;
#X connect 5 0 6 0;
#X connect 6 0 3 0;
#X connect 7 0 4 0;
#X connect 12 0 13 0;
#X connect 13 0 14 0;
#X connect 13 0 17 0;
#X connect 14 0 13 1;
#X connect 15 0 13 1;
#X connect 16 0 23 0;
#X connect 16 1 17 1;
#X connect 16 2 15 0;
#X connect 17 0 18 0;
#X connect 19 0 16 0;
#X connect 23 0 12 0;
#X connect 24 0 23 1;
#X connect 25 0 1 0;
#X connect 26 0 25 0;
#X connect 30 0 31 0;
#X connect 31 0 32 0;
#X connect 34 0 8 0;
#X connect 34 1 27 0;
#X connect 34 2 9 0;
#X connect 34 3 10 0;
#X connect 34 4 33 0;
#X connect 34 5 35 0;
#X connect 34 6 11 0;
#X connect 34 7 21 0;
#X connect 34 8 22 0;
#X connect 34 9 1 0;
#X restore 37 78 pd command-parsing;
#X obj 462 247 declare -path ./lib;
#N canvas 647 119 793 726 FFT-analysis 0;
#X obj 46 634 *~;
#X obj 237 303 rfft~;
#X obj 115 152 rfft~;
#X obj 46 510 rifft~;
#X obj 46 663 outlet~;
#X obj 456 389 block~;
#X obj 46 560 *~;
#X obj 79 118 /~;
#X obj 46 118 /~;
#X obj 46 354 /~;
#X obj 147 343 /~;
#X obj 88 585 t b f;
#X msg 88 608 2;
#X obj 88 631 /;
#X obj 134 613 * 3;
#N canvas 697 91 270 255 get-mag 0;
#X obj 69 22 inlet~;
#X obj 162 107 *~;
#X obj 69 107 *~;
#X obj 69 133 +~;
#X obj 69 157 sqrt~;
#X obj 162 22 inlet~;
#X obj 69 203 outlet~;
#X connect 0 0 2 0;
#X connect 0 0 2 1;
#X connect 1 0 3 1;
#X connect 2 0 3 0;
#X connect 3 0 4 0;
#X connect 4 0 6 0;
#X connect 5 0 1 0;
#X connect 5 0 1 1;
#X restore 71 293 pd get-mag;
#N canvas 697 91 270 255 get-mag 0;
#X obj 69 22 inlet~;
#X obj 142 67 *~;
#X obj 69 67 *~;
#X obj 69 93 +~;
#X obj 69 117 sqrt~;
#X obj 142 22 inlet~;
#X obj 69 140 +~ 1e-20;
#X obj 69 163 outlet~;
#X connect 0 0 2 0;
#X connect 0 0 2 1;
#X connect 1 0 3 1;
#X connect 2 0 3 0;
#X connect 3 0 4 0;
#X connect 4 0 6 0;
#X connect 5 0 1 0;
#X connect 5 0 1 1;
#X connect 6 0 7 0;
#X restore 88 75 pd get-mag;
#X obj 46 258 +~ 1e-15;
#N canvas 1087 158 561 795 comments 0;
#X text 43 33 Whatever the previous frame's analysis values were \,
normalize them by dividing by the magnitude. This gives all of the
complex numbers a magnitude of 1 \, but preserves their angles (phases).
;
#X text 43 593 OR \, rearranging things:;
#X text 43 113 The "read-windows" subpatch outputs windows of audio
from the sample \, with one lagging 1/4 window behind the other. The
start points of these windows are controlled by the manual "location"
control \, or if you're using the "speed" control \, the location moves
forward automatically at whatever speed.;
#X text 43 223 The rear window of audio coming out of read-windows
is transformed into the frequency domain via rfft~. We want to look
at the phases of its components and artificially alter them. When two
complex numbers are multiplied together \, their arguments/angles/phases
ADD. So \, by multiplying the unit magnitude analysis results of the
previous frame against the CONJUGATES of the rear window's components
\, we're actually SUBTRACTING their angles from the previous analysis
values. At that stage \, we've altered the complex numbers to have
the magnitudes of the rear window \, and phases: PreviousPhase MINUS
RearWindowPhase.;
#X text 43 663 In other words \, we measured the difference in phase
between the forward and rear windows (which are window-size/4 samples
apart in time) \, and then added that difference to whatever the phase
was in the last frame. We're just artificially moving the phase forward
by however much it would have gone naturally over that time period.
;
#X text 43 423 Next \, we normalize that as well \, so we have unit
magnitude again. Then we do one more complex multiply \, this time
against the front window. Again: multiplying complex numbers results
in ADDITION of their arguments/angles/phases. Last time we multiplied
against the conjugates \, so we had subtraction \, but this time we
use the original complex numbers and therefore add. So we've done something
like this with the phases:;
#X text 43 563 PreviousPhases - RearWindowPhases + ForwardWindowPhases
;
#X text 43 623 PreviousPhases + (ForwardWindowPhases - RearWindowPhases)
;
#X restore 466 140 pd comments;
#X obj 147 177 *~ -1;
#N canvas 296 55 815 371 complex-mult 0;
#X obj 420 184 *~;
#X obj 384 184 *~;
#X obj 331 184 *~;
#X obj 300 184 *~;
#X obj 300 220 -~;
#X obj 384 217 +~;
#X obj 300 258 outlet~;
#X obj 384 258 outlet~;
#X obj 300 68 inlet~;
#X obj 384 68 inlet~;
#X obj 470 68 inlet~;
#X obj 554 68 inlet~;
#X text 211 293 Real result;
#X text 444 293 Imaginary result;
#X text 20 198 (Real1 * Real2) - (Imag1 * Imag2);
#X text 50 230 MINUS \, because i*i = -1;
#X text 470 198 (Imag1 * Real2) + (Real1 * Imag2);
#X text 488 34 Second multiplicand: real/imaginary;
#X text 170 34 First multiplicand: real/imaginary;
#X connect 0 0 5 1;
#X connect 1 0 5 0;
#X connect 2 0 4 1;
#X connect 3 0 4 0;
#X connect 4 0 6 0;
#X connect 5 0 7 0;
#X connect 8 0 3 0;
#X connect 8 0 0 0;
#X connect 9 0 2 0;
#X connect 9 0 1 0;
#X connect 10 0 3 1;
#X connect 10 0 1 1;
#X connect 11 0 2 1;
#X connect 11 0 0 1;
#X restore 46 233 pd complex-mult;
#N canvas 296 54 793 368 complex-mult 0;
#X obj 415 169 *~;
#X obj 379 169 *~;
#X obj 326 169 *~;
#X obj 295 169 *~;
#X obj 295 205 -~;
#X obj 379 202 +~;
#X obj 295 243 outlet~;
#X obj 379 243 outlet~;
#X obj 295 53 inlet~;
#X obj 379 53 inlet~;
#X obj 465 53 inlet~;
#X obj 549 53 inlet~;
#X text 206 278 Real result;
#X text 439 278 Imaginary result;
#X text 15 183 (Real1 * Real2) - (Imag1 * Imag2);
#X text 45 215 MINUS \, because i*i = -1;
#X text 465 183 (Imag1 * Real2) + (Real1 * Imag2);
#X text 483 19 Second multiplicand: real/imaginary;
#X text 165 19 First multiplicand: real/imaginary;
#X connect 0 0 5 1;
#X connect 1 0 5 0;
#X connect 2 0 4 1;
#X connect 3 0 4 0;
#X connect 4 0 6 0;
#X connect 5 0 7 0;
#X connect 8 0 3 0;
#X connect 8 0 0 0;
#X connect 9 0 2 0;
#X connect 9 0 1 0;
#X connect 10 0 3 1;
#X connect 10 0 1 1;
#X connect 11 0 2 1;
#X connect 11 0 0 1;
#X restore 46 416 pd complex-mult;
#N canvas 542 225 566 495 hann-window 0;
#X obj 41 81 until;
#X obj 41 132 f;
#X obj 81 132 + 1;
#X obj 82 222 f 6.2832;
#X obj 82 297 cos;
#X obj 82 270 *;
#X obj 41 367 * 0.5;
#X obj 41 163 t b b f f;
#X msg 62 106 0;
#X obj 41 343 -;
#X msg 41 270 1;
#X obj 41 51 t f b b f;
#X obj 159 147 pack f f;
#X obj 159 123 f \$0;
#X obj 41 21 r \$0-timestretch-window-size;
#X msg 159 172 \; \$1-timestretch-hann resize \$2 \;;
#X obj 168 222 /;
#X obj 311 329 table \$0-timestretch-hann;
#X obj 41 388 tabwrite \$0-timestretch-hann;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X connect 1 0 7 0;
#X connect 2 0 1 1;
#X connect 3 0 5 0;
#X connect 4 0 9 1;
#X connect 5 0 4 0;
#X connect 6 0 18 0;
#X connect 7 0 10 0;
#X connect 7 1 3 0;
#X connect 7 2 16 0;
#X connect 7 3 18 1;
#X connect 8 0 1 1;
#X connect 9 0 6 0;
#X connect 10 0 9 0;
#X connect 11 0 0 0;
#X connect 11 1 8 0;
#X connect 11 2 13 0;
#X connect 11 3 12 1;
#X connect 11 3 16 1;
#X connect 12 0 15 0;
#X connect 13 0 12 0;
#X connect 14 0 11 0;
#X connect 16 0 5 1;
#X restore 412 47 pd hann-window;
#N canvas 717 76 441 522 read-windows 0;
#X obj 53 416 outlet~;
#X obj 283 416 outlet~;
#X obj 53 46 timestretch-reader-abs \$0 0;
#X obj 53 66 timestretch-reader-abs \$0 1;
#X obj 53 246 timestretch-reader-abs \$0 10;
#X obj 53 106 timestretch-reader-abs \$0 3;
#X obj 53 86 timestretch-reader-abs \$0 2;
#X obj 53 126 timestretch-reader-abs \$0 4;
#X obj 53 146 timestretch-reader-abs \$0 5;
#X obj 53 166 timestretch-reader-abs \$0 6;
#X obj 53 186 timestretch-reader-abs \$0 7;
#X obj 53 206 timestretch-reader-abs \$0 8;
#X obj 53 226 timestretch-reader-abs \$0 9;
#X obj 53 266 timestretch-reader-abs \$0 11;
#X obj 53 286 timestretch-reader-abs \$0 12;
#X obj 53 306 timestretch-reader-abs \$0 13;
#X obj 53 326 timestretch-reader-abs \$0 14;
#X obj 53 346 timestretch-reader-abs \$0 15;
#X connect 2 0 0 0;
#X connect 2 1 1 0;
#X connect 3 0 0 0;
#X connect 3 1 1 0;
#X connect 4 0 0 0;
#X connect 4 1 1 0;
#X connect 5 0 0 0;
#X connect 5 1 1 0;
#X connect 6 0 0 0;
#X connect 6 1 1 0;
#X connect 7 0 0 0;
#X connect 7 1 1 0;
#X connect 8 0 0 0;
#X connect 8 1 1 0;
#X connect 9 0 0 0;
#X connect 9 1 1 0;
#X connect 10 0 0 0;
#X connect 10 1 1 0;
#X connect 11 0 0 0;
#X connect 11 1 1 0;
#X connect 12 0 0 0;
#X connect 12 1 1 0;
#X connect 13 0 0 0;
#X connect 13 1 1 0;
#X connect 14 0 0 0;
#X connect 14 1 1 0;
#X connect 15 0 0 0;
#X connect 15 1 1 0;
#X connect 16 0 0 0;
#X connect 16 1 1 0;
#X connect 17 0 0 0;
#X connect 17 1 1 0;
#X restore 115 118 pd read-windows;
#X msg 456 365 set \$1 4;
#X obj 456 239 r \$0-timestretch-window-size;
#X obj 64 535 tabreceive~ \$0-timestretch-hann;
#X obj 88 562 r \$0-timestretch-window-size;
#X obj 117 478 tabsend~ \$0-timestretch-prev-real;
#X obj 157 448 tabsend~ \$0-timestretch-prev-imag;
#X obj 46 9 tabreceive~ \$0-timestretch-prev-real;
#X obj 80 40 tabreceive~ \$0-timestretch-prev-imag;
#X obj 412 7 table \$0-timestretch-prev-real;
#X obj 412 27 table \$0-timestretch-prev-imag;
#X obj 491 280 pack f \$0;
#X msg 491 300 \; \$2-timestretch-prev-real resize \$1 \; \$2-timestretch-prev-imag
resize \$1 \;;
#X text 201 177 << flip the sign of the imaginary component to get
the conjugate, f 25;
#X text 167 232 << complex multiplication: normalized previous times
the conjugate of the back window., f 27;
#X text 429 107 Detailed comments inside:;
#X text 107 509 << inverse FFT;
#X connect 0 0 4 0;
#X connect 1 0 21 2;
#X connect 1 1 21 3;
#X connect 2 0 20 2;
#X connect 2 1 19 0;
#X connect 3 0 6 0;
#X connect 6 0 0 0;
#X connect 7 0 20 1;
#X connect 8 0 20 0;
#X connect 9 0 21 0;
#X connect 10 0 21 1;
#X connect 11 0 12 0;
#X connect 11 1 14 0;
#X connect 12 0 13 0;
#X connect 13 0 0 1;
#X connect 14 0 13 1;
#X connect 15 0 9 1;
#X connect 15 0 10 1;
#X connect 16 0 7 1;
#X connect 16 0 8 1;
#X connect 17 0 15 0;
#X connect 17 0 9 0;
#X connect 19 0 20 3;
#X connect 20 0 17 0;
#X connect 20 1 15 1;
#X connect 20 1 10 0;
#X connect 21 0 3 0;
#X connect 21 0 28 0;
#X connect 21 1 3 1;
#X connect 21 1 29 0;
#X connect 23 0 2 0;
#X connect 23 1 1 0;
#X connect 24 0 5 0;
#X connect 25 0 24 0;
#X connect 25 0 34 0;
#X connect 26 0 6 1;
#X connect 27 0 11 0;
#X connect 30 0 8 0;
#X connect 30 0 16 0;
#X connect 31 0 7 0;
#X connect 31 0 16 1;
#X connect 34 0 35 0;
#X coords 0 0 16 1 0 0 0;
#X restore 37 208 pd FFT-analysis;
#N canvas 137 170 302 275 init 0;
#X obj 57 43 loadbang;
#X obj 57 64 t b b b b;
#X obj 57 175 s \$0-ts-lb4;
#X obj 117 115 s \$0-ts-lb1;
#X obj 97 135 s \$0-ts-lb2;
#X obj 77 155 s \$0-ts-lb3;
#X connect 0 0 1 0;
#X connect 1 0 2 0;
#X connect 1 1 5 0;
#X connect 1 2 4 0;
#X connect 1 3 3 0;
#X restore 462 227 pd init;
#X obj 197 254 outlet;
#X obj 197 184 r \$0-timestretch-note-off-feedback;
#X obj 197 205 list prepend note-off;
#X obj 197 226 list trim;
#X text 460 273 [timeStretch~] version 0.1.2;
#X text 460 293 William Brent \, April 2018;
#X text 241 47 Bend \, amp \, coneinue \, pause \, and playhead commands
should all be blocked if tabread \$0-timestretch-attack-active-flags
for that voice is 0 Easily done with a spigot and table lookup.;
#X connect 1 0 0 0;
#X connect 2 0 3 0;
#X connect 5 0 1 0;
#X connect 8 0 9 0;
#X connect 9 0 10 0;
#X connect 10 0 7 0;
